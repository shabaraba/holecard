#!/bin/bash
# pre-push hook: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ»Clippyãƒã‚§ãƒƒã‚¯ã¨cargo publish
#
# ã“ã®hookã¯ git push ãŒå®Ÿè¡Œã•ã‚Œã‚‹å‰ã«å‹•ä½œã—ã¾ã™ã€‚
# 1. å…¨ã¦ã®pushå‰ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¨Clippyãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
# 2. ã‚¿ã‚°ï¼ˆv*.*.*å½¢å¼ï¼‰ãŒpushã•ã‚Œã‚‹å ´åˆã€cargo publishã‚’å®Ÿè¡Œ
#
# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—:
#   cp .githooks/pre-push .git/hooks/pre-push
#   chmod +x .git/hooks/pre-push

# ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¨Clippyãƒã‚§ãƒƒã‚¯
echo "ğŸ” Running pre-push checks..."
echo ""

# cargo fmtã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
echo "â†’ Checking code format..."
if ! cargo fmt --check 2>&1; then
  echo "âŒ Code formatting check failed"
  echo "   Run 'cargo fmt' to fix formatting issues"
  exit 1
fi
echo "âœ“ Code format check passed"
echo ""

# clippy with warnings as errors
echo "â†’ Running clippy..."
if ! cargo clippy -- -D warnings 2>&1; then
  echo "âŒ Clippy check failed"
  echo "   Fix all warnings before pushing"
  exit 1
fi
echo "âœ“ Clippy check passed"
echo ""

echo "âœ… All pre-push checks passed"
echo ""

remote="$1"
url="$2"

# æ¨™æº–å…¥åŠ›ã‹ã‚‰æ›´æ–°ã•ã‚Œã‚‹å‚ç…§æƒ…å ±ã‚’èª­ã¿å–ã‚‹
while read local_ref local_sha remote_ref remote_sha
do
  # ã‚¿ã‚°ãŒpushã•ã‚Œã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  if [[ $remote_ref =~ ^refs/tags/v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
    tag_name="${remote_ref#refs/tags/}"

    echo "================================================================"
    echo "ğŸ“¦ Tag detected: $tag_name"
    echo "================================================================"
    echo ""

    # Cargo.tomlã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã‚¿ã‚°ãŒä¸€è‡´ã™ã‚‹ã‹ç¢ºèª
    cargo_version=$(grep -m1 '^version = ' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
    tag_version="${tag_name#v}"

    echo "Cargo.toml version: $cargo_version"
    echo "Tag version:        $tag_version"
    echo ""

    if [ "$cargo_version" != "$tag_version" ]; then
      echo "âŒ Error: Version mismatch!"
      echo "   Please update Cargo.toml version to match the tag."
      exit 1
    fi

    echo "âœ“ Version check passed"
    echo ""
    echo "Publishing to crates.io..."
    echo "----------------------------------------------------------------"

    # cargo publishã‚’å®Ÿè¡Œ
    if cargo publish; then
      echo "----------------------------------------------------------------"
      echo "âœ… Successfully published $tag_name to crates.io!"
      echo "================================================================"
    else
      echo "----------------------------------------------------------------"
      echo "âŒ Failed to publish to crates.io"
      echo "================================================================"
      echo ""
      echo "The tag will still be pushed to GitHub."
      echo "You can manually publish later with: cargo publish"
      echo ""
      # ã‚¨ãƒ©ãƒ¼ã§ã‚‚pushã¯ç¶™ç¶šï¼ˆexit 0ï¼‰
      # pushã‚’ä¸­æ­¢ã—ãŸã„å ´åˆã¯ exit 1 ã«ã™ã‚‹
    fi

    echo ""
  fi
done

exit 0
